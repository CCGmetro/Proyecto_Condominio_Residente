<script>
let alertModal;

document.addEventListener('DOMContentLoaded', () => {
  if (typeof bootstrap === 'undefined') {
    alert('Error: No se pudo cargar la aplicación. Revisa tu conexión.');
    return;
  }
  alertModal = new bootstrap.Modal(document.getElementById('alertModal'));

  setupAuthEventListeners(alertModal);
  setupNavigation();
  setupUIEventListeners();

  const residentRut = localStorage.getItem('residentRut');
  if (residentRut) {
    loadAndRenderInitialData(residentRut);
  } else {
    showView('login-view');
  }
});

function showView(viewId) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const view = document.getElementById(viewId);
  if (view) view.classList.add('active');
}

function loadAndRenderInitialData(rut) {
  showView('loading-view');
  
  google.script.run
    .withSuccessHandler((response) => {
      if (response && response.success) {
        setCachedData('appData', response.data);
        renderApp(response.data);
      } else {
        showAlert('Error de Datos', response?.message || 'No se pudieron cargar los datos.', alertModal);
        showView('login-view');
      }
    })
    .withFailureHandler((err) => {
      const cachedData = getCachedData('appData');
      if (cachedData) {
        showAlert('Modo Offline', 'No se pudo conectar. Mostrando últimos datos guardados.', alertModal);
        renderApp(cachedData);
      } else {
        showAlert('Error de Conexión', 'No se pudo conectar y no hay datos guardados.', alertModal);
        showView('login-view');
      }
    })
    .getInitialAppData(rut);
}

function renderApp(data) {
  try {
    if (!data || typeof data !== 'object') {
        throw new Error("Los datos recibidos no son válidos.");
    }
    // Renderizar cada componente de forma segura
    try { renderHomePage(data); } catch (e) { console.error("Error en renderHomePage:", e); }
    try { renderPackages(data.packages); } catch (e) { console.error("Error en renderPackages:", e); }
    try { renderVisits(data.visits); } catch (e) { console.error("Error en renderVisits:", e); }
    try { renderMessages(data.messages); } catch (e) { console.error("Error en renderMessages:", e); }
    try { renderProfile(data.profile); } catch (e) { console.error("Error en renderProfile:", e); }
  } catch(e) {
      console.error("Error fatal en renderApp:", e);
      showAlert('Error Crítico', 'No se pudo mostrar la información. ' + e.message, alertModal);
      handleLogout();
      return;
  }
  
  // Si todo (o parte) se renderizó sin detener el script, ahora sí cambiamos la vista.
  showView('main-view');
}

function setupNavigation() {
  const navLinks = document.querySelectorAll('.nav-link');
  navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const viewId = link.dataset.view;
      const title = link.dataset.title;
      navLinks.forEach(l => l.classList.remove('active'));
      link.classList.add('active');
      document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
      document.getElementById('view-' + viewId).classList.add('active');
      document.getElementById('header-title').textContent = title;
    });
  });
}

function setupUIEventListeners() {
  const rutInput = document.getElementById('rut');
  if (rutInput) {
    rutInput.addEventListener('input', formatoRutLive);
  }

  document.getElementById('main-view').addEventListener('click', (e) => {
    const logoutButton = e.target.closest('#logoutBtn');
    if (logoutButton) {
      handleLogout();
    }
  });
}
</script>
<script>
let alertModal, passwordChangeModal, messageDetailModal;

document.addEventListener('DOMContentLoaded', () => {
  if (typeof bootstrap === 'undefined') {
    console.error('Bootstrap no est치 cargado. La aplicaci칩n no funcionar치 correctamente.');
    alert('Error: No se pudo cargar Bootstrap. Revisa tu conexi칩n o contacta al soporte.');
    return;
  }

  const alertModalEl = document.getElementById('alertModal');
  const passwordChangeModalEl = document.getElementById('passwordChangeModal');
  const messageDetailModalEl = document.getElementById('messageDetailModal');
  
  alertModal = alertModalEl ? new bootstrap.Modal(alertModalEl) : null;
  passwordChangeModal = passwordChangeModalEl ? new bootstrap.Modal(passwordChangeModalEl) : null;
  messageDetailModal = messageDetailModalEl ? new bootstrap.Modal(messageDetailModalEl) : null;

  setupAuthEventListeners(alertModal, passwordChangeModal);
  setupNavigation();
  setupUIEventListeners();

  const residentRut = localStorage.getItem('residentRut');
  console.log('RUT del residente en localStorage:', residentRut);
  if (residentRut) {
    const cachedData = getCachedData('appData');
if (cachedData && Array.isArray(cachedData.laundry)) {
  renderApp(cachedData);
} else {
  localStorage.removeItem('appData');
  loadAndRenderInitialData(residentRut);
}
  } else {
    showView('login-view');
  }

  setTimeout(() => {
    const loadingView = document.getElementById('loading-view');
    if (loadingView?.classList.contains('active')) {
      console.warn('Timeout: Carga inicial no completada');
      loadingView.classList.remove('active');
      showView('login-view');
    }
  }, 10000);
});

function showView(viewId) {
  document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
  const view = document.getElementById(viewId);
  if (view) view.classList.add('active');
}

function loadAndRenderInitialData(rut) {
  showView('loading-view');
  document.getElementById('loading-message').textContent = 'Cargando datos...';
  
  google.script.run
    .withSuccessHandler((response) => {
      console.log('Respuesta recibida:', response);
      if (response && response.success) {
        setCachedData('appData', response.data);
        renderApp(response.data);
      } else {
        console.error('Respuesta fallida:', response);
        showAlert('Error', response?.message || 'Error al cargar datos.', alertModal);
        showView('login-view');
      }
    })
    .withFailureHandler((err) => {
      console.error('Error en la llamada:', err.message || err);
      showAlert('Error', 'Error de conexi칩n. Revisa tu internet.', alertModal);
      showView('login-view');
    })
    .getInitialAppData(rut);
}

function renderApp(data) {
  console.log("游눠 Datos para renderApp:", data);
  renderHomePage(data);
  renderPackages(data.packages);
  renderVisits(data.visits);
  renderMessages(data.messages);
  renderProfile(data.profile);
  showView('main-view');
}

function setupNavigation() {
  const navLinks = document.querySelectorAll('.nav-link');
  navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const viewId = link.dataset.view;
      const title = link.dataset.title;

      navLinks.forEach(l => l.classList.remove('active'));
      link.classList.add('active');

      document.querySelectorAll('.view-content').forEach(v => v.classList.remove('active'));
      const viewContent = document.getElementById('view-' + viewId);
      if (viewContent) {
        viewContent.classList.add('active');
        document.getElementById('header-title').textContent = title;
        window.scrollTo(0, 0);
      }
    });
  });
}

function setupUIEventListeners() {
  const mainView = document.getElementById('main-view');
  if (!mainView) return;

  mainView.addEventListener('click', (e) => {
    if (e.target.id === 'logoutBtn') handleLogout();
    if (e.target.id === 'changePhotoBtn') document.getElementById('profile-photo')?.click();
    const messageCard = e.target.closest('.message-card');
    if (messageCard) {
      const { title, message, date, seen, messageId } = messageCard.dataset;
      showMessageDetail(title, message, date, seen, messageDetailModal);
      if (seen !== 'S칈') {
        google.script.run
          .withSuccessHandler(() => {
            messageCard.classList.remove('fw-bold');
            messageCard.dataset.seen = 'S칈';
          })
          .markMessageAsRead(messageId);
      }
    }
  });

  mainView.addEventListener('submit', (e) => {
    if (e.target.id === 'profileForm') handleProfileUpdate(e, alertModal);
  });

  mainView.addEventListener('change', (e) => {
    if (e.target.id === 'profile-photo') handleFotoUpload(e, alertModal);
  });

  const rutInput = document.getElementById('rut');
  if (rutInput) rutInput.addEventListener('input', formatoRutLive);
}
</script>
